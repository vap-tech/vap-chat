# vap-chat

## Структура backend

backend/  
├── app.pl            # Основной файл приложения  
├── lib/              # Библиотеки и модули  
│   └── MyApp.pm       # Модуль приложения  
├── t/                # Тесты  
│   └── test.pl        # Примеры тестов  
├── db/               # SQL схемы и миграции  
│   └── schema.sql     # SQL схема базы данных  
├── config/           # Конфигурационные файлы  
│   └── config.json    # Файл конфигурации  
├── Dockerfile        # Файл сборки образа Docker  
├── docker-compose.yml# Файл оркестрации Docker Compose  
└── README.md          # Описание проекта  

## Oписание backend
rest api бекэнд на perl. 
База данных postgres.
Кеш redis.
Бекенд, postgres, redis в отдельных docker контейнерах, есть docker-compose файл. 

cors, домен vap-chat.v-petrenko.ru.
api версионирование.

### модели:
1) user. Поля: user_id(первичный ключ), login(обязательное)
2) user_login. Поля: email(обязательное), password(обязательное), is_verified(bool, default false или 0), user(внешний ключ на user_id из user, обязательное)
3) user_auth. Поля: refresh_token(первичный ключ), refresh_date_start(обязательное), user(внешний ключ на user_id из user, обязательное)
4) user_profile. Поля: user(внешний ключ на user_id из user, обязательное), user_name(необязательное), org_name(необязательное), department(необязательное), position(необязательное)
5) user_images. Поля: user(внешний ключ на user_id из user, обязательное), avatar(внешний ключ на image_id из images, необязательное), foto(внешний ключ на image_id из images, необязательное)
6) group. Поля: group_id(первичный ключ), owner(внешний ключ на user_id из user, обязательное), is_private(bool, обязательное), pin_message(внешний ключ на message_id, необязательное), logo(внешний ключ на image_id из images, необязательное)
7) message. Поля: from(внешний ключ на user_id из user, обязательное), header(обязательное), body(обязательное), to_user(внешний ключ на user_id из user, необязательное), to_group(внешний ключ на group_id из group, необязательное)
8) images. Поля image_id(первичный ключ), data(бинарные данные) 

### Эндпоинты:
1) Регистрация по login, email и паролю. Все три параметра обязательны, иначе возвращать 400 код ответа. метод post. пароли в базе храняться в md5. email верифицируется на наличие @, приводится к нижнему регистру. Наличие access token'a не проверяется. В случае успешной верификации cоздает новую запись в моделях user и user_login по соответствующим полям. отправляет письмо на email со ссылкой подтверждения.
2) Аутентификация по email и паролю. метод post. Email и пароль проверяются в модели user_login, если найдены то в ответе две куки access-token и refresh-tokens, используется jwt. в модель user_auth помещается refresh-tokens, в refresh_date_start идет текущий отпечаток даты-времени, в user идет user_id из модели user_login, найденный по email. access-token идет идёт в redis, ключ - user_id, время жизни 30 минут. Куки ставятся например так Set-Cookie: refreshToken='c84f18a2-c6c7-4850-be15-93f9cbaef3b3'; HttpOnly с опциями {domain: 'vap-chat.v-petrenko.ru.',  path: '/api/v1/auth'}
3) refresh_auth. полученный refreshToken и user_id ищутся в модели user_auth, если не найдены идёт ответ 404. Если найдены и текущаяя дата-время больше чем refresh_date_start как минимум на 48 часов идёт ответ 401 http, иначе генерируется новая пара access-token и refresh-tokens по аналогии с 2 эндпоинтом(Аутентификация)
3) Смена пароля пользователя, пароль должен иметь не менее 6 символов, буквы и цифры в составе, по факту изменения пароля посылать уведомление на email. метод post. Проверяется access-token на наличие его в redis по ключу user_id, если его там нет, сразу ответ 403 http. Затем старый пароль из запроса  приводится md5 и проверяется по user_id в модели user_login, если найден то заменяется на новый пароль из запроса так же приведенный к md5.
4) Редактирование профиля пользователя, поля user_id(уникальное, обязательное), user_name(необязательное), org_name(необязательное), department(необязательное), position(необязательное). Проверяется access-token на наличие его в redis по ключу user_id, если его там нет, сразу ответ 403 http. мотод post. данные из запроса валидируются на наличие только букв, цифр или пробелов, если проверки не пройдены возвращается 400 http, а если верификация успешна - данные сохраняются в модель user_profile по соответствующим полям.
5) upload_images, метод post. Проверяется access-token на наличие его в redis по ключу user_id, если его там нет, сразу ответ 403 http. Далее бинарные данные нужно сохранить в модель images по соответствующим полям.
6) CRUD для модели mesage. Проверяется access-token на наличие его в redis по ключу user_id, если его там нет, сразу ответ 403 http.
7) CRUD для модели group. Проверяется access-token на наличие его в redis по ключу user_id, если его там нет, сразу ответ 403 http.
8) CRUD для модели user_images. Проверяется access-token на наличие его в redis по ключу user_id, если его там нет, сразу ответ 403 http.
9) эндпоинт для верификации, access-token не проверяется. Устанавливает в базе is_verified в true или 1
10) эндпоинт для повторной отправки письма подтверждения электронной почты.

Возможность верификации пользователя по email, отправка всех писем через smtp, адрес отправителя будет no-reply@v-petrenko.ru , пароль для smtp хранить будем в общем конфиге бекенда.
Бекенд содержит тесты и Swagger2